<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>海上シューティング</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin: 0; background: black; overflow: hidden; }
canvas { display: block; margin: auto; background: #001f3f; }
</style>
</head>
<body>

<canvas id="game" width="400" height="600"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

//================ 状態 =================
let score = 0;
let kills = 0;
let bossLevel = 1;
let gameOver = false;
let bgY = 0;

//================ プレイヤー =================
const player = {
  x: 180, y: 500, w: 40, h: 60,
  life: 3,
  weapon: 1,
  cooldown: 0,
  invincible: 0,
  bombs: 3
};

//================ 配列 =================
let bullets = [];
let enemyBullets = [];
let enemies = [];
let items = [];
let boss = null;

//================ 入力 =================
const keys = {};
document.addEventListener("keydown", e => {
  if (e.code === "Space") shoot();
  if (e.code === "KeyB") useBomb();
  if (gameOver && e.code === "Enter") restart();
});

//================ 発射 =================
function shoot() {
  if (gameOver || player.cooldown > 0) return;

  const cx = player.x + player.w / 2;
  const patterns = {
    1: [0],
    2: [-0.1, 0.1],
    3: [-0.2, 0, 0.2],
    4: [-0.4, -0.2, 0, 0.2, 0.4]
  };

  patterns[player.weapon].forEach(a => {
    bullets.push({
      x: cx,
      y: player.y,
      vx: Math.sin(a) * 4,
      vy: -10
    });
  });

  player.cooldown = 15;
}

//================ ボム =================
function useBomb() {
  if (gameOver || player.bombs <= 0) return;

  player.bombs--;
  player.invincible = 60;
  enemyBullets = [];
  enemies.forEach(() => score += 200);
  enemies = [];

  if (boss) {
    boss.hp -= 5;
    if (boss.hp <= 0) {
      boss = null;
      bossLevel++;
      kills = 0;
    }
  }
}

//================ 敵生成 =================
setInterval(() => {
  if (!gameOver && !boss) {
    enemies.push({
      x: Math.random() * 360,
      y: -40,
      w: 30,
      h: 40,
      cool: 80
    });
  }
}, 800);

//================ 更新 =================
function update() {
  if (gameOver) return;

  bgY = (bgY + 2) % 600;

  if (keys["ArrowLeft"]) player.x -= 5;
  if (keys["ArrowRight"]) player.x += 5;
  player.x = Math.max(0, Math.min(360, player.x));

  if (player.cooldown > 0) player.cooldown--;
  if (player.invincible > 0) player.invincible--;

  bullets.forEach(b => { b.x += b.vx; b.y += b.vy; });
  bullets = bullets.filter(b => b.y > -20);

  enemyBullets.forEach(b => {
    b.x += b.vx;
    b.y += b.vy;
  });

  //================ 敵の狙い撃ち =================
  enemies.forEach(e => {
    e.y += 2;
    e.cool--;

    if (e.cool <= 0) {
      const ex = e.x + e.w / 2;
      const ey = e.y + e.h;
      const px = player.x + player.w / 2;
      const py = player.y;

      const dx = px - ex;
      const dy = py - ey;
      const len = Math.hypot(dx, dy);

      enemyBullets.push({
        x: ex,
        y: ey,
        vx: dx / len * 3,
        vy: dy / len * 3
      });

      e.cool = 80;
    }
  });

  //================ 被弾 =================
  enemyBullets.forEach((b, bi) => {
    if (player.invincible === 0 && hit(b, player)) {
      enemyBullets.splice(bi, 1);
      player.life--;
      player.weapon = Math.max(1, player.weapon - 1);
      player.invincible = 90;
      if (player.life <= 0) gameOver = true;
    }
  });
}

//================ 当たり判定 =================
function hit(a, b) {
  return a.x > b.x && a.x < b.x + (b.w || 20) &&
         a.y > b.y && a.y < b.y + (b.h || 20);
}

//================ 描画 =================
function draw() {
  ctx.clearRect(0, 0, 400, 600);

  ctx.fillStyle = "#003366";
  ctx.fillRect(0, bgY, 400, 600);
  ctx.fillRect(0, bgY - 600, 400, 600);

  if (player.invincible === 0 || Math.floor(player.invincible / 5) % 2 === 0) {
    ctx.fillStyle = "cyan";
    ctx.fillRect(player.x, player.y, player.w, player.h);
  }

  ctx.fillStyle = "yellow";
  bullets.forEach(b => ctx.fillRect(b.x - 2, b.y, 4, 10));

  ctx.fillStyle = "red";
  enemies.forEach(e => ctx.fillRect(e.x, e.y, e.w, e.h));

  ctx.fillStyle = "orange";
  enemyBullets.forEach(b => ctx.fillRect(b.x - 3, b.y, 6, 10));

  ctx.fillStyle = "white";
  ctx.fillText(`LIFE: ${player.life}`, 10, 20);
  ctx.fillText(`WEAPON: Lv${player.weapon}`, 10, 40);
  ctx.fillText(`BOMB: ${player.bombs}`, 10, 60);

  if (gameOver) ctx.fillText("GAME OVER", 150, 300);
}

//================ リスタート =================
function restart() {
  score = 0;
  kills = 0;
  bossLevel = 1;
  bullets = [];
  enemyBullets = [];
  enemies = [];
  items = [];
  boss = null;
  player.life = 3;
  player.weapon = 1;
  player.bombs = 3;
  player.invincible = 0;
  gameOver = false;
}

//================ ループ =================
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
