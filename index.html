<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Shooting Game</title>
<style>
  body {
    margin: 0;
    background: #001a33;
    overflow: hidden;
    font-family: sans-serif;
  }
  canvas {
    display: block;
    margin: auto;
    background: #003366;
  }
  #ui {
    position: fixed;
    top: 10px;
    left: 10px;
    color: white;
    font-size: 16px;
  }
</style>
</head>
<body>

<div id="ui"></div>
<canvas id="game" width="480" height="640"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const ui = document.getElementById("ui");

/* ===== 定数 ===== */
const ENEMY_SPEED = 2;
const PLAYER_SPEED = 6;

/* ===== 状態 ===== */
let gameOver = false;
let score = 0;
let kills = 0;
let bossPhase = 0;

/* ===== 背景 ===== */
let bgY = 0;

/* ===== 自機 ===== */
const player = {
  x: 240,
  y: 520,
  w: 30,
  h: 40,
  life: 5,
  maxLife: 5,
  weapon: 1,
  invincible: 0,
  shooting: false
};

/* ===== 配列 ===== */
let bullets = [];
let enemies = [];
let enemyBullets = [];
let items = [];
let boss = null;

/* ===== マウス操作 ===== */
canvas.addEventListener("mousemove", e => {
  const rect = canvas.getBoundingClientRect();
  player.x = e.clientX - rect.left;
  player.y = e.clientY - rect.top;
});
canvas.addEventListener("mousedown", () => player.shooting = true);
canvas.addEventListener("mouseup", () => player.shooting = false);

/* ===== リスタート ===== */
document.addEventListener("keydown", e => {
  if (e.key === "r" && gameOver) location.reload();
});

/* ===== 弾発射 ===== */
let shotCooldown = 0;
function shoot() {
  if (shotCooldown > 0) return;
  shotCooldown = 10;

  if (player.weapon === 1) {
    bullets.push({x: player.x, y: player.y, vy: -8});
  } else {
    bullets.push({x: player.x - 8, y: player.y, vy: -8});
    bullets.push({x: player.x + 8, y: player.y, vy: -8});
  }
}

/* ===== 敵生成 ===== */
function spawnEnemy() {
  if (boss) return;
  const type = Math.random() < 0.5 ? 1 : 2;
  enemies.push({
    x: Math.random() * 440 + 20,
    y: -40,
    w: 30,
    h: 30,
    type,
    shootTimer: 60
  });
}

/* ===== ボス生成 ===== */
function spawnBoss() {
  boss = {
    x: 240,
    y: 100,
    w: 120,
    h: 60,
    hp: 30 + bossPhase * 20,
    timer: 0
  };
}

/* ===== 更新 ===== */
function update() {
  if (gameOver) return;

  bgY = (bgY + 1) % canvas.height;

  if (player.shooting) shoot();
  if (shotCooldown > 0) shotCooldown--;
  if (player.invincible > 0) player.invincible--;

  /* 自機弾 */
  bullets.forEach(b => b.y += b.vy);
  bullets = bullets.filter(b => b.y > -20);

  /* 敵 */
  enemies.forEach(e => {
    e.y += ENEMY_SPEED;
    e.shootTimer--;
    if (e.shootTimer <= 0) {
      if (e.type === 1) {
        enemyBullets.push({x: e.x, y: e.y, vy: 4});
      } else {
        enemyBullets.push({x: e.x - 8, y: e.y, vy: 4});
        enemyBullets.push({x: e.x + 8, y: e.y, vy: 4});
      }
      e.shootTimer = 90;
    }
  });
  enemies = enemies.filter(e => e.y < 700);

  /* 敵弾 */
  enemyBullets.forEach(b => b.y += b.vy);
  enemyBullets = enemyBullets.filter(b => b.y < 700);

  /* ボス */
  if (boss) {
    boss.timer++;
    if (boss.timer % 30 === 0) {
      enemyBullets.push({x: boss.x, y: boss.y, vy: 4});
      enemyBullets.push({x: boss.x - 40, y: boss.y, vy: 4});
      enemyBullets.push({x: boss.x + 40, y: boss.y, vy: 4});
    }
  }

  /* 当たり判定（弾→敵） */
  bullets.forEach(b => {
    enemies.forEach(e => {
      if (hit(b, e)) {
        e.y = 999;
        b.y = -999;
        score += 100;
        kills++;

        if (Math.random() < 0.3) {
          const type = Math.random() < 0.5 ? "heal" : "weapon";
          items.push({x: e.x, y: e.y, type});
        }
      }
    });

    if (boss && hit(b, boss)) {
      boss.hp--;
      b.y = -999;
      if (boss.hp <= 0) {
        boss = null;
        bossPhase++;
        kills = 0;
      }
    }
  });

  /* 敵弾→自機 */
  enemyBullets.forEach(b => {
    if (player.invincible === 0 && hit(b, player)) {
      player.life--;
      player.weapon = Math.max(1, player.weapon - 1);
      player.invincible = 60;
      b.y = 999;
      if (player.life <= 0) gameOver = true;
    }
  });

  /* アイテム */
  items.forEach(i => {
    i.y += 2;
    if (hit(i, player)) {
      if (i.type === "heal") {
        player.life = Math.min(player.maxLife, player.life + 1);
      }
      if (i.type === "weapon") {
        player.weapon = Math.min(2, player.weapon + 1);
      }
      i.y = 999;
    }
  });
  items = items.filter(i => i.y < 700);

  if (kills >= 20 && !boss) spawnBoss();
  if (Math.random() < 0.02) spawnEnemy();
}

/* ===== 描画 ===== */
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  /* 背景 */
  ctx.fillStyle = "#004488";
  ctx.fillRect(0, bgY, canvas.width, canvas.height);
  ctx.fillRect(0, bgY - canvas.height, canvas.width, canvas.height);

  /* 自機 */
  ctx.fillStyle = player.invincible ? "rgba(255,255,255,0.5)" : "#00ffcc";
  ctx.fillRect(player.x - 15, player.y - 20, 30, 40);

  /* 自機弾 */
  ctx.fillStyle = "#ffff00";
  bullets.forEach(b => ctx.fillRect(b.x - 2, b.y - 6, 4, 12));

  /* 敵 */
  ctx.fillStyle = "#ff5555";
  enemies.forEach(e => ctx.fillRect(e.x - 15, e.y - 15, 30, 30));

  /* 敵弾 */
  ctx.fillStyle = "#ffcc00";
  enemyBullets.forEach(b => ctx.fillRect(b.x - 3, b.y - 6, 6, 12));

  /* ボス */
  if (boss) {
    ctx.fillStyle = "#888";
    ctx.fillRect(boss.x - 60, boss.y - 30, 120, 60);
  }

  /* アイテム */
  items.forEach(i => {
    ctx.fillStyle = i.type === "heal" ? "#00ff00" : "#00aaff";
    ctx.fillRect(i.x - 8, i.y - 8, 16, 16);
  });

  /* UI */
  ui.innerHTML = `
    SCORE: ${score}<br>
    LIFE: ${player.life}<br>
    WEAPON Lv.${player.weapon}
    ${gameOver ? "<br><b>GAME OVER<br>Rで再スタート</b>" : ""}
  `;
}

/* ===== 判定 ===== */
function hit(a, b) {
  return Math.abs(a.x - b.x) < 20 && Math.abs(a.y - b.y) < 20;
}

/* ===== ループ ===== */
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
