<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æµ·STG</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{margin:0;overflow:hidden;background:#001a33}
canvas{display:block}
</style>
</head>
<body>
<canvas id="game"></canvas>

<script>
/* ===== Canvas ===== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

/* ===== Audio ===== */
const bgm = new Audio("https://cdn.pixabay.com/audio/2022/03/15/audio_2c4b8a1e5b.mp3");
bgm.loop = true; bgm.volume = 0.4;
const seShot = new Audio("https://cdn.pixabay.com/audio/2022/03/10/audio_8fbe7f90b2.mp3");
const seBoom = new Audio("https://cdn.pixabay.com/audio/2022/03/15/audio_7b6d7bbf48.mp3");

/* ===== State ===== */
let gameOver=false, score=0, time=0;
let killCount=0, boss=null, bossPhase=0;
let enemies=[], bullets=[], enemyBullets=[], items=[];

/* ===== Player ===== */
const player={
  x:canvas.width/2, y:canvas.height-120,
  life:5, weapon:1, cool:0, inv:0
};

/* ===== Mouse ===== */
canvas.addEventListener("mousemove",e=>{
  player.x=e.clientX;
  player.x=Math.max(20,Math.min(canvas.width-20,player.x));
});
canvas.addEventListener("mousedown",()=>gameOver?location.reload():shoot());

/* ===== Shoot ===== */
function shoot(){
  if(player.cool>0||gameOver)return;
  seShot.cloneNode().play();
  for(let i=0;i<player.weapon;i++){
    bullets.push({
      x:player.x+(i-(player.weapon-1)/2)*10,
      y:player.y, vx:(i-(player.weapon-1)/2), vy:-8
    });
  }
  player.cool=8;
}

/* ===== Enemy Spawn ===== */
function spawnEnemy(){
  if(boss||gameOver)return;
  const type=Math.random()<0.6?0:1;
  enemies.push({
    x:Math.random()*canvas.width, y:-40,
    hp:type?5:2, type:type,
    cool:60+Math.random()*60
  });
}

/* ===== Boss ===== */
function spawnBoss(){
  bossPhase++;
  boss={
    x:canvas.width/2,y:80,
    hp:100*bossPhase,max:100*bossPhase,
    cool:0, pattern:0
  };
}

/* ===== Update ===== */
function update(){
  if(gameOver)return;
  if(bgm.paused)bgm.play();
  time++;

  player.cool--; player.inv--;

  /* Difficulty */
  const diff=1+time/1800+score/5000;

  /* Player Bullets */
  bullets.forEach(b=>{b.x+=b.vx;b.y+=b.vy});
  bullets=bullets.filter(b=>b.y>-50);

  /* Enemies */
  enemies.forEach(e=>{
    e.y+=2*diff;
    e.cool--;
    if(e.cool<=0){
      const dx=player.x-e.x,dy=player.y-e.y;
      const l=Math.hypot(dx,dy);
      enemyBullets.push({x:e.x,y:e.y,vx:dx/l*3,vy:dy/l*3});
      e.cool=80;
    }
  });
  enemies=enemies.filter(e=>e.y<canvas.height+50&&e.hp>0);

  /* Enemy Bullets */
  enemyBullets.forEach(b=>{b.x+=b.vx;b.y+=b.vy});
  enemyBullets=enemyBullets.filter(b=>b.y>-50&&b.y<canvas.height+50);

  /* Hit Enemy */
  bullets.forEach(b=>{
    enemies.forEach(e=>{
      if(Math.hypot(b.x-e.x,b.y-e.y)<20){
        e.hp--; b.y=-999;
        if(e.hp<=0){
          score+=100; killCount++;
          if(Math.random()<0.15) items.push({x:e.x,y:e.y});
          seBoom.cloneNode().play();
        }
      }
    });
  });

  /* Boss Spawn */
  if(killCount>=20&&!boss){killCount=0;spawnBoss();}

  /* Boss Logic */
  if(boss){
    boss.cool--;
    if(boss.cool<=0){
      boss.pattern=(boss.pattern+1)%3;
      boss.cool=120;
    }
    if(boss.pattern===0){
      for(let i=-2;i<=2;i++)
        enemyBullets.push({x:boss.x,y:boss.y,vx:i*1.5,vy:4});
    }
    if(boss.pattern===1){
      for(let a=0;a<360;a+=30){
        enemyBullets.push({
          x:boss.x,y:boss.y,
          vx:Math.cos(a*Math.PI/180)*3,
          vy:Math.sin(a*Math.PI/180)*3
        });
      }
    }
    if(boss.pattern===2){
      const dx=player.x-boss.x,dy=player.y-boss.y;
      const l=Math.hypot(dx,dy);
      enemyBullets.push({x:boss.x,y:boss.y,vx:dx/l*5,vy:dy/l*5});
    }

    bullets.forEach(b=>{
      if(Math.abs(b.x-boss.x)<70&&Math.abs(b.y-boss.y)<40){
        boss.hp--; b.y=-999;
      }
    });

    if(boss.hp<=0){
      score+=3000; boss=null;
      seBoom.cloneNode().play();
    }
  }

  /* Player Hit */
  enemyBullets.forEach(b=>{
    if(Math.hypot(b.x-player.x,b.y-player.y)<15&&player.inv<=0){
      player.life--; player.weapon=Math.max(1,player.weapon-1);
      player.inv=60;
      if(player.life<=0)gameOver=true;
    }
  });

  /* Items */
  items.forEach(it=>it.y+=2);
  items=items.filter(it=>{
    if(Math.hypot(it.x-player.x,it.y-player.y)<20){
      player.weapon=Math.min(5,player.weapon+1);
      player.life=Math.min(5,player.life+1);
      return false;
    }
    return it.y<canvas.height;
  });
}

/* ===== Draw ===== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  /* Player */
  ctx.fillStyle=player.inv>0?"rgba(0,255,255,0.5)":"#0ff";
  ctx.beginPath();
  ctx.moveTo(player.x,player.y-20);
  ctx.lineTo(player.x-15,player.y+20);
  ctx.lineTo(player.x+15,player.y+20);
  ctx.fill();

  /* Bullets */
  ctx.fillStyle="#ff0";
  bullets.forEach(b=>ctx.fillRect(b.x,b.y,4,8));

  /* Enemies */
  enemies.forEach(e=>{
    ctx.fillStyle=e.type?"#888":"#aaa";
    ctx.fillRect(e.x-15,e.y-15,30,30);
  });

  /* Enemy Bullets */
  ctx.fillStyle="#f44";
  enemyBullets.forEach(b=>ctx.fillRect(b.x,b.y,6,6));

  /* Boss */
  if(boss){
    ctx.fillStyle="#555";
    ctx.fillRect(boss.x-80,boss.y-30,160,60);
    ctx.fillStyle="red";
    ctx.fillRect(20,20,(boss.hp/boss.max)*300,10);
  }

  /* Items */
  ctx.fillStyle="#0f0";
  items.forEach(it=>ctx.fillRect(it.x-6,it.y-6,12,12));

  /* UI */
  ctx.fillStyle="#fff";
  ctx.fillText(`SCORE ${score}`,20,canvas.height-20);
  ctx.fillText(`LIFE ${player.life}`,140,canvas.height-20);
  ctx.fillText(`WEAPON Lv${player.weapon}`,240,canvas.height-20);

  if(gameOver){
    ctx.font="40px sans-serif";
    ctx.fillText("GAME OVER (CLICK)",canvas.width/2-200,canvas.height/2);
  }
}

/* ===== Loop ===== */
setInterval(spawnEnemy,800);
function loop(){update();draw();requestAnimationFrame(loop);}
loop();
</script>
</body>
</html>
