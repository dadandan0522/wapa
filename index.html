<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>海STG</title>
<style>
body {
  margin: 0;
  overflow: hidden;
  background: #001a33;
}
canvas {
  display: block;
}

/* 自機 */
.player {
  width: 40px;
  height: 40px;
}

/* 敵（小型戦艦） */
.enemy {
  width: 30px;
  height: 30px;
}

/* ボス（戦艦） */
.boss {
  width: 120px;
  height: 60px;
}
</style>
</head>
<body>
<canvas id="game"></canvas>

<script>
/* ===== Canvas ===== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

/* ===== Audio ===== */
const bgm = new Audio("https://cdn.pixabay.com/audio/2022/03/15/audio_2c4b8a1e5b.mp3");
bgm.loop = true;
bgm.volume = 0.4;

const seShot = new Audio("https://cdn.pixabay.com/audio/2022/03/10/audio_8fbe7f90b2.mp3");
const seExplosion = new Audio("https://cdn.pixabay.com/audio/2022/03/15/audio_7b6d7bbf48.mp3");

/* ===== Game State ===== */
let gameOver = false;
let score = 0;
let enemiesKilled = 0;
let bossLevel = 0;

/* ===== Player ===== */
const player = {
  x: canvas.width / 2,
  y: canvas.height - 100,
  size: 20,
  life: 5,
  weaponLevel: 1,
  cooldown: 0,
  invincible: 0
};

let bullets = [];
let enemies = [];
let enemyBullets = [];
let items = [];
let boss = null;

/* ===== Mouse Control ===== */
canvas.addEventListener("mousemove", e => {
  player.x = e.clientX;
  player.y = e.clientY;
});

canvas.addEventListener("mousedown", () => shoot());

/* ===== Shoot ===== */
function shoot() {
  if (player.cooldown > 0 || gameOver) return;

  seShot.cloneNode().play();

  for (let i = 0; i < player.weaponLevel; i++) {
    bullets.push({
      x: player.x + (i - player.weaponLevel / 2) * 8,
      y: player.y,
      vx: (i - (player.weaponLevel - 1) / 2) * 1.2,
      vy: -8
    });
  }
  player.cooldown = 10;
}

/* ===== Enemy Spawn ===== */
function spawnEnemy() {
  if (boss || gameOver) return;
  enemies.push({
    x: Math.random() * canvas.width,
    y: -30,
    hp: 2
  });
}

/* ===== Boss Spawn ===== */
function spawnBoss() {
  bossLevel++;
  boss = {
    x: canvas.width / 2,
    y: 80,
    hp: 30 + bossLevel * 20,
    maxHp: 30 + bossLevel * 20,
    cooldown: 0
  };
}

/* ===== Restart ===== */
window.addEventListener("keydown", e => {
  if (e.key === "r") location.reload();
});

/* ===== Update ===== */
function update() {
  if (gameOver) return;

  if (!bgm.paused) {} else bgm.play();

  player.cooldown--;
  player.invincible--;

  /* Player Bullets */
  bullets.forEach(b => {
    b.x += b.vx;
    b.y += b.vy;
  });
  bullets = bullets.filter(b => b.y > -50);

  /* Enemies */
  enemies.forEach(e => e.y += 2);

  /* Enemy Bullets */
  enemyBullets.forEach(b => {
    b.x += b.vx;
    b.y += b.vy;
  });
  enemyBullets = enemyBullets.filter(b => b.y < canvas.height + 50);

  /* Collision: Bullet vs Enemy */
  bullets.forEach(b => {
    enemies.forEach(e => {
      if (Math.hypot(b.x - e.x, b.y - e.y) < 20) {
        e.hp--;
        b.y = -999;
        if (e.hp <= 0) {
          score += 100;
          enemiesKilled++;
          seExplosion.cloneNode().play();
          e.y = canvas.height + 999;
        }
      }
    });
  });

  enemies = enemies.filter(e => e.y < canvas.height);

  /* Boss Logic */
  if (enemiesKilled >= 20 && !boss) {
    enemiesKilled = 0;
    spawnBoss();
  }

  if (boss) {
    boss.cooldown--;
    if (boss.cooldown <= 0) {
      for (let i = -2; i <= 2; i++) {
        enemyBullets.push({
          x: boss.x,
          y: boss.y,
          vx: i * 1.2,
          vy: 4
        });
      }
      boss.cooldown = 40;
    }

    bullets.forEach(b => {
      if (Math.abs(b.x - boss.x) < 80 && Math.abs(b.y - boss.y) < 40) {
        boss.hp--;
        b.y = -999;
      }
    });

    if (boss.hp <= 0) {
      score += 2000;
      seExplosion.cloneNode().play();
      boss = null;
    }
  }

  /* Player Hit */
  enemyBullets.forEach(b => {
    if (
      Math.hypot(b.x - player.x, b.y - player.y) < 15 &&
      player.invincible <= 0
    ) {
      player.life--;
      player.weaponLevel = Math.max(1, player.weaponLevel - 1);
      player.invincible = 60;
      if (player.life <= 0) gameOver = true;
    }
  });
}

/* ===== Draw ===== */
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  /* Player */
  ctx.fillStyle = player.invincible > 0 ? "rgba(0,255,255,0.5)" : "#00ffff";
  ctx.beginPath();
  ctx.moveTo(player.x, player.y - 20);
  ctx.lineTo(player.x - 15, player.y + 20);
  ctx.lineTo(player.x + 15, player.y + 20);
  ctx.fill();

  /* Bullets */
  ctx.fillStyle = "#ffff00";
  bullets.forEach(b => ctx.fillRect(b.x, b.y, 4, 8));

  /* Enemies */
  ctx.fillStyle = "#aaa";
  enemies.forEach(e => ctx.fillRect(e.x - 15, e.y - 15, 30, 30));

  /* Enemy Bullets */
  ctx.fillStyle = "#ff4444";
  enemyBullets.forEach(b => ctx.fillRect(b.x, b.y, 6, 6));

  /* Boss */
  if (boss) {
    ctx.fillStyle = "#666";
    ctx.fillRect(boss.x - 60, boss.y - 30, 120, 60);

    /* Boss HP */
    ctx.fillStyle = "#f00";
    ctx.fillRect(50, 20, (boss.hp / boss.maxHp) * 300, 10);
  }

  /* UI */
  ctx.fillStyle = "#fff";
  ctx.fillText("SCORE: " + score, 20, canvas.height - 20);
  ctx.fillText("LIFE: " + player.life, 150, canvas.height - 20);

  if (gameOver) {
    ctx.fillStyle = "red";
    ctx.font = "40px sans-serif";
    ctx.fillText("GAME OVER (Rで再開)", canvas.width / 2 - 200, canvas.height / 2);
  }
}

/* ===== Loop ===== */
setInterval(spawnEnemy, 800);
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>

